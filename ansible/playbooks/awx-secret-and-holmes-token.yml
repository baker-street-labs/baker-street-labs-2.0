# EXTRACTED FROM PRODUCTION BAKER STREET MONOREPO â€“ 2025-12-03
# Verified working in active cyber range for 18+ months
# Part of the official Tier 1 / Tier 2 crown jewels audit (Conservative Option A)
# DO NOT REFACTOR UNLESS EXPLICITLY APPROVED

---
- name: Retrieve AWX admin password
  hosts: localhost
  gather_facts: false
  tags:
    - awx_secret
  collections:
    - kubernetes.core
  vars:
    kubeconfig_path: "{{ lookup('env', 'KUBECONFIG') | default(ansible_env.HOME + '/.kube/config', true) }}"
  tasks:
    - name: Fetch awx-admin-password secret
      k8s_info:
        api_version: v1
        kind: Secret
        name: awx-admin-password
        namespace: awx
        kubeconfig: "{{ kubeconfig_path }}"
      register: awx_secret

    - name: Ensure AWX secret exists
      ansible.builtin.assert:
        that:
          - awx_secret.resources | length > 0
        fail_msg: "Secret awx-admin-password was not found in namespace awx"

    - name: Decode AWX admin password
      ansible.builtin.set_fact:
        awx_admin_password: "{{ awx_secret.resources[0].data.password | b64decode }}"

    - name: Display AWX admin password (remove log after storing securely)
      ansible.builtin.debug:
        msg: "AWX admin password: {{ awx_admin_password }}"

- name: Persist Holmes DNS API token in ~/.secrets
  hosts: localhost
  gather_facts: false
  tags:
    - holmes_token
  vars:
    secrets_file: "{{ lookup('env', 'HOME') + '/.secrets' }}"
  tasks:
    - name: Require holmes_api_token variable
      ansible.builtin.assert:
        that:
          - holmes_api_token is defined
          - holmes_api_token | length >= 32
        fail_msg: "Provide -e holmes_api_token=<token> (>=32 chars) when running this play."

    - name: Ensure ~/.secrets exists with strict permissions
      ansible.builtin.file:
        path: "{{ secrets_file }}"
        state: touch
        mode: "0600"

    - name: Write HOLMES_API_TOKEN entry
      ansible.builtin.lineinfile:
        path: "{{ secrets_file }}"
        regexp: "^HOLMES_API_TOKEN="
        line: "HOLMES_API_TOKEN={{ holmes_api_token }}"
        create: true
        mode: "0600"

    - name: Confirm token placement
      ansible.builtin.debug:
        msg: "HOLMES_API_TOKEN updated in {{ secrets_file }}. Store securely and redistribute via AWX inventory or vault as needed."
