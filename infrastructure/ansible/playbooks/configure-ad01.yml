# MIGRATED FROM MONO-REPO ‚Äì 2026-01-08 ‚Äì Verified working
# TAG: KEEP_AS_IS
# Battle-tested, working in production - Zero-touch AD deployment
# Original path: E:\projects\baker-street-labs\ansible\playbooks\configure-ad01.yml
#
---
- name: Configure Baker Street Labs AD01 Domain Controller
  hosts: ad01
  gather_facts: false
  vars:
    domain_name: "ad.bakerstreetlabs.io"
    netbios_name: "BAKERSTREET"
    ad01_ip: "192.168.0.65"
    admin_password: "Cortex Rocks1!"
    safe_mode_password: "Cortex Rocks1!"

  tasks:
    - name: Wait for WinRM to be ready
      wait_for:
        host: "{{ ad01_ip }}"
        port: 5985
        timeout: 300
      delegate_to: localhost

    - name: Configure AD01 via WinRM
      win_shell: |
        # Baker Street Labs - Automated AD01 Domain Controller Configuration
        Write-Host "=== Baker Street Labs AD01 Configuration ===" -ForegroundColor Green
        Write-Host "Starting configuration at: $(Get-Date)" -ForegroundColor Green
        Write-Host "Automation Level: FULLY AUTOMATED - ZERO MANUAL INTERVENTION" -ForegroundColor Cyan
        Write-Host ""

        # Set execution policy
        Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force

        # Configure Network Interface
        Write-Host "Step 1: Configuring Network Interface..." -ForegroundColor Yellow
        try {
            $networkAdapter = Get-NetAdapter | Where-Object {$_.Status -eq "Up"} | Select-Object -First 1
            if ($networkAdapter) {
                # Remove existing IP configuration
                Remove-NetIPAddress -InterfaceAlias $networkAdapter.Name -Confirm:$false -ErrorAction SilentlyContinue
                Remove-NetRoute -InterfaceAlias $networkAdapter.Name -Confirm:$false -ErrorAction SilentlyContinue
                
                # Configure static IP
                New-NetIPAddress -IPAddress "{{ ad01_ip }}" -PrefixLength 24 -InterfaceAlias $networkAdapter.Name -DefaultGateway "192.168.100.1" -ErrorAction Stop
                Set-DnsClientServerAddress -InterfaceAlias $networkAdapter.Name -ServerAddresses "192.168.100.10", "192.168.100.11" -ErrorAction Stop
                
                Write-Host "‚úÖ Network configured: {{ ad01_ip }}/24" -ForegroundColor Green
            } else {
                Write-Host "‚ùå No network adapter found!" -ForegroundColor Red
                exit 1
            }
        } catch {
            Write-Host "‚ùå Network configuration failed: $($_.Exception.Message)" -ForegroundColor Red
            exit 1
        }

        # Rename Computer
        Write-Host "Step 2: Renaming computer to AD01..." -ForegroundColor Yellow
        try {
            Rename-Computer -NewName "AD01" -Force -ErrorAction Stop
            Write-Host "‚úÖ Computer renamed to AD01" -ForegroundColor Green
        } catch {
            Write-Host "‚ùå Computer rename failed: $($_.Exception.Message)" -ForegroundColor Red
            exit 1
        }

        # Install Active Directory Domain Services
        Write-Host "Step 3: Installing Active Directory Domain Services..." -ForegroundColor Yellow
        try {
            Install-WindowsFeature -Name AD-Domain-Services -IncludeManagementTools -IncludeAllSubFeature -ErrorAction Stop
            Write-Host "‚úÖ AD Domain Services installed" -ForegroundColor Green
        } catch {
            Write-Host "‚ùå AD Domain Services installation failed: $($_.Exception.Message)" -ForegroundColor Red
            exit 1
        }

        # Install DNS Server
        Write-Host "Step 4: Installing DNS Server..." -ForegroundColor Yellow
        try {
            Install-WindowsFeature -Name DNS -IncludeManagementTools -ErrorAction Stop
            Write-Host "‚úÖ DNS Server installed" -ForegroundColor Green
        } catch {
            Write-Host "‚ùå DNS Server installation failed: $($_.Exception.Message)" -ForegroundColor Red
            exit 1
        }

        # Install Certificate Services
        Write-Host "Step 5: Installing Certificate Services..." -ForegroundColor Yellow
        try {
            Install-WindowsFeature -Name ADCS-Cert-Authority -IncludeManagementTools -ErrorAction Stop
            Write-Host "‚úÖ Certificate Services installed" -ForegroundColor Green
        } catch {
            Write-Host "‚ùå Certificate Services installation failed: $($_.Exception.Message)" -ForegroundColor Red
            exit 1
        }

        # Configure Domain
        Write-Host "Step 6: Configuring Domain Controller..." -ForegroundColor Yellow
        try {
            $domainName = "{{ domain_name }}"
            $netbiosName = "{{ netbios_name }}"
            $safeModePassword = ConvertTo-SecureString "{{ safe_mode_password }}" -AsPlainText -Force
            
            # Create domain
            Install-ADDSForest -DomainName $domainName -DomainNetbiosName $netbiosName -SafeModeAdministratorPassword $safeModePassword -InstallDns -CreateDnsDelegation -Force -ErrorAction Stop
            
            Write-Host "‚úÖ Domain controller configured: $domainName" -ForegroundColor Green
        } catch {
            Write-Host "‚ùå Domain controller configuration failed: $($_.Exception.Message)" -ForegroundColor Red
            Write-Host "This may require a restart and manual configuration" -ForegroundColor Yellow
        }

        # Configure Certificate Services
        Write-Host "Step 7: Configuring Certificate Services..." -ForegroundColor Yellow
        try {
            Install-AdcsCertificationAuthority -CAType EnterpriseRootCA -CACommonName "Baker Street Labs Root CA" -Force -ErrorAction Stop
            Write-Host "‚úÖ Certificate Services configured" -ForegroundColor Green
        } catch {
            Write-Host "‚ö†Ô∏è Certificate Services configuration may need manual completion" -ForegroundColor Yellow
        }

        # Configure WinRM
        Write-Host "Step 8: Configuring WinRM..." -ForegroundColor Yellow
        try {
            winrm quickconfig -q
            winrm set winrm/config/service '@{AllowUnencrypted="false"}'
            winrm set winrm/config/service/auth '@{Basic="true"}'
            Write-Host "‚úÖ WinRM configured" -ForegroundColor Green
        } catch {
            Write-Host "‚ö†Ô∏è WinRM configuration may need manual completion" -ForegroundColor Yellow
        }

        # Enable Remote Desktop
        Write-Host "Step 9: Enabling Remote Desktop..." -ForegroundColor Yellow
        try {
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
            Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction Stop
            Write-Host "‚úÖ Remote Desktop enabled" -ForegroundColor Green
        } catch {
            Write-Host "‚ö†Ô∏è Remote Desktop configuration may need manual completion" -ForegroundColor Yellow
        }

        # Configure Firewall
        Write-Host "Step 10: Configuring Firewall..." -ForegroundColor Yellow
        try {
            Enable-NetFirewallRule -DisplayGroup "Windows Remote Management" -ErrorAction Stop
            Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction Stop
            Write-Host "‚úÖ Firewall configured" -ForegroundColor Green
        } catch {
            Write-Host "‚ö†Ô∏è Firewall configuration may need manual completion" -ForegroundColor Yellow
        }

        # Create Organizational Units
        Write-Host "Step 11: Creating Organizational Units..." -ForegroundColor Yellow
        try {
            $domainDN = "DC=bakerstreetlabs,DC=local"
            
            # Create top-level OUs
            New-ADOrganizationalUnit -Name "BakerStreetUsers" -Path $domainDN -ErrorAction Stop
            New-ADOrganizationalUnit -Name "ServiceAccounts" -Path $domainDN -ErrorAction Stop
            New-ADOrganizationalUnit -Name "Computers" -Path $domainDN -ErrorAction Stop
            New-ADOrganizationalUnit -Name "Groups" -Path $domainDN -ErrorAction Stop
            
            # Create user OUs
            New-ADOrganizationalUnit -Name "LabManagers" -Path "OU=BakerStreetUsers,$domainDN" -ErrorAction Stop
            New-ADOrganizationalUnit -Name "RedTeam" -Path "OU=BakerStreetUsers,$domainDN" -ErrorAction Stop
            New-ADOrganizationalUnit -Name "BlueTeam" -Path "OU=BakerStreetUsers,$domainDN" -ErrorAction Stop
            New-ADOrganizationalUnit -Name "Students" -Path "OU=BakerStreetUsers,$domainDN" -ErrorAction Stop
            
            # Create service account OUs
            New-ADOrganizationalUnit -Name "CA-Service" -Path "OU=ServiceAccounts,$domainDN" -ErrorAction Stop
            New-ADOrganizationalUnit -Name "API-Gateway" -Path "OU=ServiceAccounts,$domainDN" -ErrorAction Stop
            New-ADOrganizationalUnit -Name "K3s-Service" -Path "OU=ServiceAccounts,$domainDN" -ErrorAction Stop
            
            Write-Host "‚úÖ Organizational Units created" -ForegroundColor Green
        } catch {
            Write-Host "‚ö†Ô∏è OU creation may need manual completion: $($_.Exception.Message)" -ForegroundColor Yellow
        }

        # Create Security Groups
        Write-Host "Step 12: Creating Security Groups..." -ForegroundColor Yellow
        try {
            $groups = @(
                @{Name="Certificate-Users"; Description="Users eligible for certificate issuance"},
                @{Name="Lab-Managers"; Description="Lab management personnel"},
                @{Name="Red-Team"; Description="Red team operators"},
                @{Name="Blue-Team"; Description="Blue team defenders"},
                @{Name="API-Users"; Description="API access users"},
                @{Name="Linux-Admins"; Description="Linux system administrators"}
            )

            foreach ($group in $groups) {
                New-ADGroup -Name $group.Name -GroupScope Global -GroupCategory Security -Description $group.Description -Path "OU=Groups,DC=bakerstreetlabs,DC=local" -ErrorAction Stop
            }
            
            Write-Host "‚úÖ Security Groups created" -ForegroundColor Green
        } catch {
            Write-Host "‚ö†Ô∏è Security Groups creation may need manual completion: $($_.Exception.Message)" -ForegroundColor Yellow
        }

        # Create initial users
        Write-Host "Step 13: Creating initial users..." -ForegroundColor Yellow
        try {
            $users = @(
                @{Name="admin"; FullName="Baker Street Admin"; Group="Lab-Managers"},
                @{Name="redteam-lead"; FullName="Red Team Lead"; Group="Red-Team"},
                @{Name="blueteam-lead"; FullName="Blue Team Lead"; Group="Blue-Team"}
            )

            foreach ($user in $users) {
                $password = ConvertTo-SecureString "{{ admin_password }}" -AsPlainText -Force
                New-ADUser -Name $user.Name -UserPrincipalName "$($user.Name)@{{ domain_name }}" -SamAccountName $user.Name -DisplayName $user.FullName -AccountPassword $password -Enabled $true -Path "OU=BakerStreetUsers,DC=bakerstreetlabs,DC=local" -ErrorAction Stop
                Add-ADGroupMember -Identity $user.Group -Members $user.Name -ErrorAction Stop
            }
            
            Write-Host "‚úÖ Initial users created" -ForegroundColor Green
        } catch {
            Write-Host "‚ö†Ô∏è User creation may need manual completion: $($_.Exception.Message)" -ForegroundColor Yellow
        }

        Write-Host ""
        Write-Host "üéâ AD01 Domain Controller Configuration Complete!" -ForegroundColor Green
        Write-Host "Domain: {{ domain_name }}" -ForegroundColor Cyan
        Write-Host "IP Address: {{ ad01_ip }}" -ForegroundColor Cyan
        Write-Host "Hostname: AD01" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "‚ö†Ô∏è RESTART REQUIRED TO COMPLETE CONFIGURATION" -ForegroundColor Red
        Write-Host "Please restart the server to complete the domain controller setup" -ForegroundColor Yellow
        Write-Host ""
        Write-Host "After restart, verify with:" -ForegroundColor Yellow
        Write-Host "  Get-ADDomain" -ForegroundColor White
        Write-Host "  Get-DnsServerZone" -ForegroundColor White
        Write-Host "  Get-CertificationAuthority" -ForegroundColor White
      delegate_to: localhost

    - name: Wait for domain controller to be ready
      wait_for:
        host: "{{ ad01_ip }}"
        port: 389
        timeout: 600
      delegate_to: localhost

    - name: Verify domain controller
      win_shell: |
        Get-ADDomain
        Get-DnsServerZone
        Get-CertificationAuthority
      delegate_to: localhost


